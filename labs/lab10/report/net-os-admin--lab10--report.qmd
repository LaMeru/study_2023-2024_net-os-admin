---
## Author
author:
  name: Чигладзе Майя Владиславовна
  degrees: student
  orcid: 0000-0002-0877-7063
  email: 1132239399@pfur.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 119530
      city: Москва
      address: ул. Очаковское шоссе, д. 9А

## Title
title: "Отчёт по лабораторной работе №10"
subtitle: "Администрирование сетевых подсистем"
license: "CC BY"
---

# Цель работы

Приобретение практических навыков по конфигурированию SMTP-сервера в части
настройки аутентификации.

# Задание

1. Настройте Dovecot для работы с LMTP (см. раздел 10.4.1).
2. Настройте аутентификацию посредством SASL на SMTP-сервере (см. раздел 10.4.2).
3. Настройте работу SMTP-сервера поверх TLS (см. раздел 10.4.3).
4. Скорректируйте скрипт для Vagrant, фиксирующий действия расширенной на-
стройки SMTP-сервера во внутреннем окружении виртуальной машины server (см.
раздел 10.4.4).

# Теоретическое введение

Local Mail Transfer Protocol (LMTP) — протокол локальной пересылки почты.
По сути, Dovecot с включённым в него функционалом LMTP выступает в качестве ло-
кального агента доставки почты, т.е. является службой приёма почтовых сообщений от
SMTP-сервера для последующей их пересылки клиентам локальной сети. Использова-
ние Dovecot и протокола LMTP позволяет организовать фильтрацию почты на стороне
сервера в момент размещения письма в почтовый ящик, а не на стороне клиента.

# Выполнение лабораторной работы

## Настройка LMTP в Dovecote

1. На виртуальной машине server войдите под вашим пользователем и откройте тер-
минал. Перейдите в режим суперпользователя:
sudo -i (см. рис. @fig-011).

![Входим в суперпользователя](image/1.1.jpg){#fig-011 width=70%}

2. В дополнительном терминале запустите мониторинг работы почтовой службы:
sudo -i
tail -f /var/log/maillog (см. рис. @fig-012).

![Запускаем мониторинг](image/1.2.jpg){#fig-012 width=70%}

3. Добавьте в список протоколов, с которыми может работать Dovecot, протокол LMTP.
Для этого в файле /etc/dovecot/dovecot.conf укажите

4. Настройте в Dovecot сервис lmtp для связи с Postfix. Для этого в файле
/etc/dovecot/conf.d/10-master.conf замените определение сервиса lmtp на сле-
дующую запись (см. рис. @fig-014).

![Настраиваем довкэт](image/1.4.jpg){#fig-014 width=70%}

5. Переопределите в Postfix с помощью postconf передачу сообщений не на прямую,
а через заданный unix-сокет:
postconf -e 'mailbox_transport = lmtp:unix:private/dovecot-lmtp' ([рис. @fig-015]).

![Переопределяем Постфикс](image/1.5.jpg){#fig-015 width=70%}

6. В файле /etc/dovecot/conf.d/10-auth.conf задайте формат имени пользователя
для аутентификации в форме логина пользователя без указания домена:
auth_username_format = %Ln ([рис. @fig-016]).

![Задаем формат](image/1.6.jpg){#fig-016 width=70%}

7. Перезапустите Postfix и Dovecot:
systemctl restart postfix
systemctl restart dovecot ([рис. @fig-017]).

![перезапускаем постфикс](image/1.7.jpg){#fig-017 width=70%}

8. Из-под учётной записи своего пользователя отправьте письмо с клиента (вместо
user укажите ваш логин):
echo .| mail -s "LMTP test" user@user.net 
В отчёт включите свои пояснения по содержанию логов при мониторинге почтовой
службы. ([рис. @fig-018]).

![Отправляем письмо](image/1.8.jpg){#fig-018 width=70%}

9. На сервере просмотрите почтовый ящик пользователя:
MAIL=~/Maildir/ mail
Убедитесь, что отправленное вами с клиента письмо доставлено в почтовый ящик
на сервере. ([рис. @fig-019]).

![На сервере просмотрим почтовый ящик](image/1.9.jpg){#fig-019 width=70%}

# Настройка SMTP-аутентификации

1. В файле /etc/dovecot/conf.d/10-master.conf определите службу аутентификации
пользователей ([рис. @fig-021]).

Пояснение: 
Эта конфигурация определяет, как Dovecot будет обрабатывать запросы на аутентификацию. Она создает два UNIX сокета:
Один для взаимодействия с Postfix, позволяя Postfix отправлять запросы на аутентификацию в Dovecot. Права доступа настроены так, чтобы только Postfix мог использовать этот сокет.
Другой для внутренних целей, обеспечивая доступ к базе данных пользователей только для самого Dovecot.

Важно, чтобы права доступа к этим сокетам были настроены правильно для обеспечения безопасности и предотвращения несанкционированного доступа к информации об аутентификации.  Соответствие прав доступа и пользователей/групп, указанных в конфигурации, реальным пользователям и группам в системе, критически важно для корректной работы почтовой системы.

![Определяем службу аутентификации](image/2.1.jpg){#fig-021 width=70%}

2. Для Postfix задайте тип аутентификации SASL для smtpd и путь к соответствующему
unix-сокету:
postconf -e 'smtpd_sasl_type = dovecot'
postconf -e 'smtpd_sasl_path = private/auth' ([рис. @fig-022]).

![Задаем тип аутентификации](image/2.2.jpg){#fig-022 width=70%}

3. Настройте Postfix для приёма почты из Интернета только для обслуживаемых на-
шим сервером пользователей или для произвольных пользователей локальной
машины (имеется в виду локальных пользователей сервера), обеспечивая тем
самым запрет на использование почтового сервера в качестве SMTP relay для спам-
рассылок (порядок указания опций имеет значение):
postconf -e 'smtpd_recipient_restrictions =
reject_unknown_recipient_domain, permit_mynetworks,
reject_non_fqdn_recipient, reject_unauth_destination,
reject_unverified_recipient, permit'(см. рис. @fig-023).

Пояснение:

Общий эффект этой конфигурации:

•  Защита от спама: Отклоняет письма на несуществующие домены, некорректные адреса и потенциально на несуществующих пользователей.

•  Запрет на открытую ретрансляцию: Главным образом достигается за счет reject_unauth_destination, который не позволяет неавторизованным клиентам отправлять почту на домены, не обслуживаемые нашим сервером.

•  Разрешение для доверенных отправителей: permit_mynetworks позволяет внутренним системам или авторизованным клиентам (если они в mynetworks) использовать сервер для отправки почты куда угодно.

•  Прием почты для локальных пользователей: Почта, предназначенная для доменов, обслуживаемых сервером (указанных в mydestination, virtual_mailbox_domains и т.п.), будет принята после прохождения всех проверок.

![Настраиваем постфикс](image/2.3.jpg){#fig-023 width=70%}

4. В настройках Postfix ограничьте приём почты только локальным адресом SMTP-
сервера сети:
postconf -e 'mynetworks = 127.0.0.0/8' (см. рис. @fig-024).

![Ограничиваем прием почты](image/2.4.jpg){#fig-024 width=70%}

5. Для проверки работы аутентификации временно запустим SMTP-сервер
(порт 25) с возможностью аутентификации. Для этого необходимо в файле
/etc/postfix/master.cf заменить строку ([рис. @fig-025]).

![Запускаем смт сервер](image/2.5.jpg){#fig-025 width=70%}

6. Перезапустите Postfix и Dovecot:
systemctl restart postfix
systemctl restart dovecot ([рис. @fig-026]).

![Перезапускаем постфикс](image/2.6.jpg){#fig-026 width=70%}

7. На клиенте установите telnet:
sudo -i
dnf -y install telnet ([рис. @fig-027]).

![Устаналвиваем телнет](image/2.7.jpg){#fig-027 width=70%}

8. На клиенте получите строку для аутентификации, вместо username указав логин
вашего пользователя, а вместо password указав пароль этого пользовател ([рис. @fig-028]).

![Получаем строку аутентификации](image/2.8.jpg){#fig-028 width=70%}

9. Подключитесь на клиенте к SMTP-серверу посредством telnet (вместо user укажите
ваш логин) ([рис. @fig-029]).

![Подключаемся к клиенту](image/2.9.jpg){#fig-029 width=70%}

## Настройка SMTP over TLS

1. Настройте на сервере TLS, воспользовавшись временным сертификатом Dovecot.
Предварительно скопируйте необходимые файлы сертификата и ключа из каталога
/etc/pki/dovecot в каталог /etc/pki/tls/ в соответствующие подкаталоги (чтобы
не было проблем с SELinux) ([рис. @fig-031]).

![Настраивает тлс на сервере](image/3.1.jpg){#fig-031 width=70%}

2. Для того чтобы запустить SMTP-сервер на 587-м порту, в файле
/etc/postfix/master.cf замените строки  ([рис. @fig-032]).

![Заменяем строки в файле](image/3.2.jpg){#fig-032 width=70%}

3. Настройте межсетевой экран, разрешив работать службе smtp-submission:
firewall-cmd --get-services
firewall-cmd --add-service=smtp-submission
firewall-cmd --add-service=smtp-submission --permanent
firewall-cmd --reload ([рис. @fig-033]).

![Настраиваем межсетевой экран](image/3.3.jpg){#fig-033 width=70%}

4. Перезапустите Postfix:
systemctl restart postfix ([рис. @fig-034]).

![Перезаупскаем постфикс](image/3.4.jpg){#fig-034 width=70%}

5. На клиенте подключитесь к SMTP-серверу через 587-й порт посредством openssl
(вместо user используйте свой логин):
openssl s_client -starttls smtp -crlf -connect server.user.net:587
Протестируйте подключение по telnet:
EHLO test
Проверьте аутентификацию:
AUTH PLAIN <строка для аутентификации> ([рис. @fig-035]).

![Подключаемся к серверу](image/3.5.jpg){#fig-035 width=70%}

6. Проверьте корректность отправки почтовых сообщений с клиента посредством
почтового клиента Evolution, предварительно скорректировав настройки учётной
записи, а именно для SMTP-сервера укажите порт 587, STARTTLS и обычный пароль. ([рис. @fig-036]).

![Проверяем корректность работы](image/3.6.jpg){#fig-036 width=70%}

![Проверяем корректность работы](image/3.7.jpg){#fig-036 width=70%}

## Внесение изменений в настройки внутреннего окружения виртуальной машины

1. На виртуальной машине server перейдите в каталог для внесения изменений в на-
стройки внутреннего окружения /vagrant/provision/server/. В соответствующие
подкаталоги поместите конфигурационные файлы Dovecot и Postfix 

2. Внесите соответствующие изменения по расширенной конфигурации SMTP-
сервера в файл /vagrant/provision/server/mail.sh ([рис. @fig-042]).

![Вносим изменения](image/4.2.jpg){#fig-042 width=70%}

3. Внесите изменения в файл /vagrant/provision/client/mail.sh, добавив установку
telnet. ([рис. @fig-043]).

![Вносим изменения телнет](image/4.3.jpg){#fig-043 width=70%}

# Выводы

В ходе выполнения лабораторной работы я приобрела практические навыки по конфигурированию SMTP-сервера в части
настройки аутентификации.

# Список литературы{.unnumbered}

1. Postfix SASL Howto. — URL: http : / / www . postfix . org / SASL _ README . html (visited on
09/13/2021).

::: {#refs}
:::
