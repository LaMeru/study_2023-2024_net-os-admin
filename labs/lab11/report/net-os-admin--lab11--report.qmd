---
## Author
author:
  name: Чигладзе Майя Владиславовна
  degrees: student
  orcid: 0000-0002-0877-7063
  email: 1132239399@pfur.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 119530
      city: Москва
      address: ул. Очаковское шоссе, д. 9А

## Title
title: "Отчёт по лабораторной работе №11"
subtitle: "Администрирование сетевых подсистем"
license: "CC BY"
---

# Цель работы

Приобретение практических навыков по настройке удалённого доступа к серверу
с помощью SSH.

# Задание

1. Настройте запрет удалённого доступа на сервер по SSH для пользователя root 
2. Настройте разрешение удалённого доступа к серверу по SSH только для пользова-
телей группы vagrant и вашего пользователя (см. раздел 11.4.2).
3. Настройте удалённый доступ к серверу по SSH через порт 2022 (см. раздел 11.4.3).
4. Настройте удалённый доступ к серверу по SSH по ключу (см. раздел 11.4.4).
5. Организуйте SSH-туннель с клиента на сервер, перенаправив локальное соедине-
ние с TCP-порта 80 на порт 8080 (см. раздел 11.4.5).
6. Используя удалённое SSH-соединение, выполните с клиента несколько команд на
сервере (см. раздел 11.4.6).
7. Используя удалённое SSH-соединение, запустите с клиента графическое приложе-
ние на сервере (см. раздел 11.4.7).
8. Напишите скрипт для Vagrant, фиксирующий действия по настройке SSH-сервера
во внутреннем окружении виртуальной машины server. Соответствующим образом
внесите изменения в Vagrantfile (см. раздел 11.4.8).

# Теоретическое введение

Протокол SSH (Secure Shell) позволяет организовать защищённый и безопасный
удалённый доступ к узлам сети поверх небезопасных каналов связи.
Безопасность соединений по протоколу SSH обеспечивается за счёт шифрования со-
единения, аутентификации сервера и клиента, проверки целостности передаваемых
по организованному соединению данных.

SSH-соединение имеет серверную и клиентскую части. Серверная часть на
Unix/Linux узлах реализуется процессом sshd по умолчанию через TCP-порт 22. На-
стройки sshd обычно располагаются в файле /etc/ssh/sshd_config.

# Выполнение лабораторной работы

## Запрет удалённого доступа по SSH для пользователя root

1. На сервере задайте пароль для пользователя root, если этого не было сделано ранее:
sudo -i
passwd root (см. рис. @fig-011).

![Задаем пароль](image/1.1.jpg){#fig-011 width=70%}

2. На сервере в дополнительном терминале запустите мониторинг системных собы-
тий:
sudo -i
journalctl -x -f (см. рис. @fig-012).

![Запускаем мониторинг](image/1.2.jpg){#fig-012 width=70%}

3. С клиента попытайтесь получить доступ к серверу посредством SSH-соединения
через пользователя root:
ssh root@server.user.net (см. рис. @fig-013).

![Получаем доступ к сервере](image/1.3.jpg){#fig-013 width=70%}

4. На сервере откройте файл /etc/ssh/sshd_config конфигурации sshd для редакти-
рования и запретите вход на сервер пользователю root, установив:
PermitRootLogin no (см. рис. @fig-014).

![Открываем файл на редактирование](image/1.4.jpg){#fig-014 width=70%}

5. После сохранения изменений в файле конфигурации перезапустите sshd:
systemctl restart sshd ([рис. @fig-015]).

![Перезапускаем систему](image/1.5.jpg){#fig-015 width=70%}

6. Повторите попытку получения доступа с клиента к серверу посредством SSH-
соединения через пользователя root:
ssh root@server ([рис. @fig-016]).

![Повторяем попытку](image/1.6.jpg){#fig-016 width=70%}

Пояснение:
Я попыталась подключиться к серверу как root: выполнила команду ssh root@server. Клиент сработал, запросил пароль, я его ввела, но сервер ответил 'Permission denied, please try again.' Это значит, что аутентификация по паролю не прошла. Причины могут быть разные: неверный пароль, запрет на вход под root в /etc/ssh/sshd_config (PermitRootLogin), отключение пароля как метода аутентификации (PasswordAuthentication no) или блокировка со стороны PAM/fail2ban. 

## Ограничение списка пользователей для удаленного доступа по SSH

1. С клиента попытайтесь получить доступ к серверу посредством SSH-соединения
через пользователя user (вместо user укажите вашего пользователя):
ssh user@server.user.net ([рис. @fig-021]).

![Получаем доступ к серверу](image/2.1.jpg){#fig-021 width=70%}

Пояснение:
1. Запрос пароля: Сервер запросил пароль для этого пользователя.
2. Успешная аутентификация: Я ввела пароль, и ура, он сработал!
3. Установление сессии: Сервер принял пароль, выдал мне системное сообщение (про cockpit — это такая веб-консоль, неважно) и показал время последнего входа.
4. Результат: Самое главное — изменилась командная строка! Теперь я вижу [mvchigladze@server.mvchigladze.net ~]$. Это значит, что я успешно залогинилась и сейчас работаю уже не на клиенте, а прямо на удаленном сервере, используя свою обычную учетную запись. Соединение установлено, всё как надо!

2. На сервере откройте файл /etc/ssh/sshd_config конфигурации sshd на редактиро-
вание и добавьте строку
AllowUsers vagrant (см. рис. @fig-022).

![Открываем файл и добавляем строку](image/2.2.jpg){#fig-022 width=70%}

3. После сохранения изменений в файле конфигурации перезапустите sshd:
systemctl restart sshdь (см. рис. @fig-023).

![Перезапускаем систему](image/2.3.jpg){#fig-023 width=70%}

4. Повторите попытку получения доступа с клиента к серверу посредством
SSH-соединения через пользователя user:
ssh user@server.user.net (см. рис. @fig-024).

![Повторяем попытку получения доступа](image/2.4.jpg){#fig-024 width=70%}

Пояснение:
Отказ в доступе (Permission denied): Я ввожу пароль, но мне снова отказывают!

Почему отказали?

Это произошло из-за того, что мы только что сделали в предыдущих шагах:

•  Мы добавили в конфигурацию SSH (/etc/ssh/sshd_config) строку: AllowUsers vagrant.
•  Когда в конфиге SSH есть директива AllowUsers, это означает, что только перечисленные пользователи могут зайти.
•  Поскольку пользователь mvchigladze не был указан в списке AllowUsers, сервер автоматически отклонил попытку входа, даже если пароль был верным. Конфигурация перекрыла право на вход.

## Настройка дополнительных портов для удалённого доступа по SSH

1. На сервере в файле конфигурации sshd /etc/ssh/sshd_config найдите строку Port
и ниже этой строки добавьте:
Port 22
Port 2022
Эта запись сообщает процессу sshd о необходимости организации соединения через
два разных порта, что даёт гарантию возможности открыть сеансы SSH, даже если
была сделана ошибка в конфигурации. ([рис. @fig-031]).

![Добавляем строки](image/3.1.jpg){#fig-031 width=70%}

2. После сохранения изменений в файле конфигурации перезапустите sshd:
systemctl restart sshd ([рис. @fig-032]).

![Перезапускаем](image/3.2.jpg){#fig-032 width=70%}

3. Посмотрите расширенный статус работы sshd:
systemctl status -l sshd
Система должна сообщить вам об отказе в работе sshd через порт 2022. Дополни-
тельно посмотрите сообщения в терминале с мониторингом системных событий.
В отчёте поясните суть системных сообщений. ([рис. @fig-033]).

![Расщиренный статус работы](image/3.3.jpg){#fig-033 width=70%}

Пояснение:
- Строки сервиса:
 - Loaded / Active / Main PID / Tasks / Memory — стандартная информация systemd о службе sshd: сервис загружен и сейчас активен (running), указан PID основного процесса.
 - CGroup — дочерние потоки/процессы sshd (listener, net, priv).

- Логи (ниже): последовательность событий при старте sshd:
 - "Starting OpenSSH server daemon" — systemd пытается запустить sshd.
 - "error: Bind to port 2022 on ..." (повторяется) — sshd попытался открыть (привязать) сетевой сокет на порту 2022, но не смог. Обычно это означает, что порт уже занят другим процессом или привязка невозможна по другой причине.
 - "Started OpenSSH server daemon" и далее "Server listening on 0.0.0.0:22" и "Server listening on :: : port 22" — несмотря на ошибку с 2022, sshd успешно запустился и слушает на порту 22 (IPv4 и IPv6).

Суть: я добавила в конфиг два порта (22 и 2022). При перезапуске sshd он успешно открыл порт 22, но не смог открыть 2022 — поэтому в логах видно сообщение об ошибке привязки к 2022, но сам демон работает на 22.

4. Исправьте на сервере метки SELinux к порту 2022:
semanage port -a -t ssh_port_t -p tcp 2022 ([рис. @fig-034]).

![Исправляем метки](image/3.4.jpg){#fig-034 width=70%}

5. В настройках межсетевого экрана откройте порт 2022 протокола TCP:
firewall-cmd --add-port=2022/tcp
firewall-cmd --add-port=2022/tcp --permanent ([рис. @fig-035]).

![Открываем порт](image/3.5.jpg){#fig-035 width=70%}

6. Вновь перезапустите sshd и посмотрите расширенный статус его работы. Статус
должен показать, что процесс sshd теперь прослушивает два порта. ([рис. @fig-036]).

![Перезаупскаем и смотрим статус](image/3.6.jpg){#fig-036 width=70%}

7. С клиента попытайтесь получить доступ к серверу посредством SSH-соединения
через пользователя user (вместо user укажите вашего пользователя):
ssh user@server.user.net
После открытия оболочки пользователя введите sudo -i для получения доступа
root. Отлогиньтесь от root и вашего пользователя на сервере, введя дважды logout
или используя дважды комбинацию клавиш Ctrl + d . ([рис. @fig-037]).

![С клиента пытаемся получить доступ к серверу](image/3.7.jpg){#fig-037 width=70%}

8. Повторите попытку получения доступа с клиента к серверу посредством
SSH-соединения через пользователя user, указав порт 2022:
ssh -p2022 user@server.user.net
После открытия оболочки пользователя введите sudo -i для получения доступа
root. Отлогиньтесь от root и вашего пользователя на сервере, введя дважды logout
или используя дважды комбинацию клавиш Ctrl + d . ([рис. @fig-038]).

![Повторяем попытку](image/3.8.jpg){#fig-038 width=70%}

## Настройка удаленного доступа в SSH по ключу

1. На сервере в конфигурационном файле /etc/ssh/sshd_config задайте параметр,
разрешающий аутентификацию по ключу:
PubkeyAuthentication yes ([рис. @fig-041]).

![Задаем параметр](image/4.1.jpg){#fig-041 width=70%}

2. После сохранения изменений в файле конфигурации перезапустите sshd. ([рис. @fig-042]).

![Перезапускаем ссхд](image/4.2.jpg){#fig-042 width=70%}

3. На клиенте сформируйте SSH-ключ, введя в терминале под пользователем user
(вместо user используйте ваш логин):
ssh-keygen
Когда вас спросят, хотите ли вы использовать кодовую фразу, нажмите Enter , что-
бы использовать установку без пароля. При запросе имени файла, в котором
будет храниться закрытый ключ, примите предлагаемое по умолчанию имя файла
(~/.ssh/id_rsa). Когда вас попросят ввести кодовую фразу, нажмите Enter дважды. ([рис. @fig-043]).

![Сформируйте ссх ключ](image/4.3.jpg){#fig-043 width=70%}

4. Закрытый ключ теперь будет записан в файл ~/.ssh/id_rsa, а открытый ключ за-
писывается в файл ~/.ssh/id_rsa.pub.

5. Скопируйте открытый ключ на сервер, введя на клиенте (вместо user укажите ва-
шего пользователя):
ssh-copy-id user@server.user.net
При запросе введите пароль пользователя на удалённом сервере. ([рис. @fig-045]).

![Скопируйте открытый ключ](image/4.5.jpg){#fig-045 width=70%}

6. Попробуйте получить доступ с клиента к серверу посредством SSH-соединения
(вместо user используйте ваш логин):
ssh user@server.user.net
Теперь вы должны пройти аутентификацию без ввода пароля для учётной записи
удалённого пользователя. Отлогиньтесь с сервера, используя комбинацию клавиш
Ctrl + d . ([рис. @fig-046]).

![Попробуйте получить доступ с клиента к серверу](image/4.6.jpg){#fig-046 width=70%}

## Организация туннелей SSH, перенаправление TCP-портов

1. На клиенте посмотрите, запущены ли какие-то службы с протоколом TCP:
lsof | grep TCP ([рис. @fig-051]).

![Запущены ли какие-то службы](image/5.1.jpg){#fig-051 width=70%}

2. Перенаправьте порт 80 на server.user.net на порт 8080 на локальной машине
(вместо user используйте ваш логин):
ssh -fNL 8080:localhost:80 user@server.user.net ([рис. @fig-052]).

![Перенаправьте порт на сервер](image/5.2.jpg){#fig-052 width=70%}

3. Вновь на клиенте посмотрите, запущены ли какие-то службы с протоколом TCP:
lsof | grep TCP ([рис. @fig-053]).

![Запущены ли на клиенте какие-то службы](image/5.3.jpg){#fig-053 width=70%}

Пояснение: 
 На скрине видно вывод lsof с протоколом TCP: показаны процессы sshd/ssh и их соединения (строки с ESTABLISHED и LISTEN).
- Строки ESTABLISHED показывают активные SSH‑сессии между клиентом и сервером — значит туннель/соединение установлено.
- Появившаяся строка localhost:webcache (LISTEN) — это локальный сокет, который теперь слушает на localhost (имя service webcache соответствует порту 8080). Этот слушатель создан процессом ssh (флаг -N -L), т.е. локальный порт 8080 привязан и ожидает подключений.
- Как результат: любые подключения к localhost:8080 на клиенте будут перенаправляться через SSH на удалённый сервер и там доставляться к порту 80 (http).
- Итого кратко: туннель успешно создан — ssh слушает локальный порт (8080) и имеет установленные SSH‑соединения для перенаправления трафика на удалённый порт 80.

4. На клиенте запустите браузер и в адресной строке введите localhost:8080. Убе-
дитесь, что отобразится страница с приветствием «Welcome to the server.user.net
server». ([рис. @fig-054]).

![Запустила браузер](image/5.4.jpg){#fig-054 width=70%}

## Запуск консольных приложений через SSH

1. На клиенте откройте терминал под пользователем user вместо user используйте 

2. Посмотрите с клиента имя узла сервера:
ssh user@server.user.net hostname  ([рис. @fig-062]).

![Посмотрела с клиента имя узла и сервер](image/6.2.jpg){#fig-062 width=70%}

3. Посмотрите с клиента список файлов на сервере:
ssh user@server.user.net ls -Al  ([рис. @fig-063]).

![Посмотрела список файлов](image/6.3.jpg){#fig-063 width=70%}

4. Посмотрите с клиента почту на сервере:
ssh user@server.user.net MAIL=~/Maildir/ mail  ([рис. @fig-064]).

![Посмотрела почту](image/6.4.jpg){#fig-064 width=70%}

##  Запуск графических приложений через SSH (X11Forwarding)

1. На сервере в конфигурационном файле /etc/ssh/sshd_config разрешите отобра-
жать на локальном клиентском компьютере графические интерфейсы X11:
X11Forwarding yes ([рис. @fig-071]).

![Разрешила отображать](image/7.1.jpg){#fig-071 width=70%}

2. После сохранения изменения в конфигурационном файле перезапустите sshd. ([рис. @fig-072]).

![Перезапуск](image/7.2.jpg){#fig-072 width=70%}

3. Попробуйте с клиента удалённо подключиться к серверу и запустить графическое
приложение, например firefox (вместо user используйте ваш логин):
ssh -YC user@server.user.net firefox ([рис. @fig-073]).

![Подключаюсь к серверу](image/7.3.jpg){#fig-073 width=70%}

## Внесение изменений в настройки внутреннего окружения виртуальной машины

1. На виртуальной машине server перейдите в каталог для внесения изменений
в настройки внутреннего окружения /vagrant/provision/server/, создайте в нём
каталог ssh, в который поместите в соответствующие подкаталоги конфигурацион-
ный файл sshd_config:
cd /vagrant/provision/server
mkdir -p /vagrant/provision/server/ssh/etc/ssh
cp -R /etc/ssh/sshd_config /vagrant/provision/server/ssh/etc/ssh/ ([рис. @fig-081]).

![Перехожу в каталог](image/8.1.jpg){#fig-081 width=70%}

2. В каталоге /vagrant/provision/server создайте исполняемый файл ssh.sh ([рис. @fig-082]).

![Изменяю файл](image/8.2.jpg){#fig-082 width=70%}

3. Для отработки созданного скрипта во время загрузки виртуальной машины server
в конфигурационном файле Vagrantfile необходимо добавить в разделе конфигу-
рации для сервер ([рис. @fig-083]).

![Изменяю вагрантфайл](image/8.3.jpg){#fig-083 width=70%}

# Выводы

В ходе выполнения лабораторной работы, я получила практические навыки по настройке удалённого доступа к серверу
с помощью SSH

# Список литературы{.unnumbered}

::: {#refs}
:::
