---
## Author
author:
  name: Чигладзе Майя Владиславовна
  degrees: student
  orcid: 0000-0002-0877-7063
  email: 1132239399@pfur.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 119530
      city: Москва
      address: ул. Очаковское шоссе, д. 9А

## Title
title: "Отчёт по лабораторной работе №13"
subtitle: "Администрирование сетевых подсистем"
license: "CC BY"
---

# Цель работы

Приобретение навыков настройки сервера NFS для удалённого доступа к ресурсам.

# Задание

1. Установите и настройте сервер NFSv4 
2. Подмонтируйте удалённый ресурс на клиенте
3. Подключите каталог с контентом веб-сервера к дереву NFS.
4. Подключите каталог для удалённой работы вашего пользователя к дереву NFS 
5. Напишите скрипты для Vagrant, фиксирующие действия по установке и настрой-
ке сервера NFSv4 во внутреннем окружении виртуальных машин server и client.
6. Соответствующим образом внесите изменения в Vagrantfile .

# Теоретическое введение

Протокол сетевого доступа к файловым системам (Network File System, NFS) пред-
назначен для монтирования через сеть файловых систем, расположенных на других
узлах сети.
Данный протокол работает в соответствии с клиент-серверной архитектурой. Кли-
енты NFS имеют прозрачный доступ к ресурсам файловой системы NFS-сервера.
Прозрачность доступа в этом случае означает, что любое приложение клиента может
работать не с локальным, а с подмонтированным через NFS файлом без модификаций
настроек приложения. При этом доступ к файлам на сервере NFS клиенты получают
с помощью отправки соответствующих RPC-запросов на сервер. Протокол удалённого
вызова процедур (RPC) определяет формат всех взаимодействий между клиентом
и сервером. Семантику монтирования и размонтирования файловых систем NFS опре-
деляет протокол монтирования (процесс mountd).
Для организации удалённого доступа к ресурсам с помощью NFS должны быть вы-
полнены процедуры экспортирования и монтирования каталогов. Сервер NFS должен
экспортировать каталог, после чего клиент NFS может смонтировать его в точке мон-
тирования в своём пространстве имён и работать с ним, как с локальным ресурсом.
Экспортирование каталога в данном случае означает, что каталог в пространстве
имён сервера становится доступным для клиента в соответствии с заданными при
экспорте правами доступа. Экспортируемые каталоги должны быть указаны в файле
/etc/exports.

# Выполнение лабораторной работы

## Настройка сервера NFSv4

1. На сервере установите необходимое программное обеспечение:
dnf -y install nfs-utils (см. рис. @fig-011).

![Установим программное обеспечение](image/1.1.jpg){#fig-011 width=70%}

2. На сервере создайте каталог, который предполагается сделать доступным всем
пользователям сети (корень дерева NFS):
mkdir -p /srv/nfs (см. рис. @fig-012).

![Создадим каталог](image/1.2.jpg){#fig-012 width=70%}

3. В файле /etc/exports пропишите подключаемый через NFS общий каталог с досту-
пом только на чтение:
/srv/nfs *(ro) (см. рис. @fig-013).

![Пропишим общий каталог](image/1.3.jpg){#fig-013 width=70%}

4. Для общего каталога задайте контекст безопасности NFS:
semanage fcontext -a -t nfs_t "/srv/nfs(/.*)?" (см. рис. @fig-014).

![Пропишим контекст безопасности](image/1.4.jpg){#fig-014 width=70%}

5. Примените изменённую настройку SELinux к файловой системе:
restorecon -vR /srv/nfs ([рис. @fig-015]).

![Применим измененную настройку](image/1.5.jpg){#fig-015 width=70%}

6. Запустите сервер NFS:
systemctl start nfs-server.service
systemctl enable nfs-server.service ([рис. @fig-016]).

![Запускаем сервер](image/1.6.jpg){#fig-016 width=70%}

7. Настройте межсетевой экран для работы сервера NFS:
firewall-cmd --add-service=nfs
firewall-cmd --add-service=nfs --permanent
firewall-cmd --reload ([рис. @fig-017]).

![Настраиваем межсетевой экран](image/1.7.jpg){#fig-017 width=70%}

8. На клиенте установите необходимое для работы NFS программное обеспечение:
dnf -y install nfs-utils ([рис. @fig-018]).

![Устанавливаем ПО](image/1.8.jpg){#fig-018 width=70%}

9. На клиенте попробуйте посмотреть имеющиеся подмонтированные удалённые
ресурсы (вместо user укажите свой логин):
showmount -e server.user.net ([рис. @fig-019]).

![Смотрим ресурсы](image/1.9.jpg){#fig-019 width=70%}

Пояснение:

•  Это значит, что клиент не смог получить ответ от сервера.

•  Хотя мы на сервере NFS запустили и даже добавили сервис nfs в файрвол, скорее всего, файрвол блокирует какой-то из вспомогательных портов, которые нужны для работы RPC (Remote Procedure Call) — это такая технология, на которой держится NFS.

•  Короче говоря, сервер не смог отправить клиенту нужную информацию, и клиент завис в ожидании. Наш NFS пока не работает, скорее всего, из-за сетевых ограничений.

10. Попробуйте на сервере остановить сервис межсетевого экрана:
systemctl stop firewalld.service
Затем на клиенте вновь попробуйте подключиться к удалённо смонтированному
ресурсу:
showmount -e server.user.net ([рис. @fig-110]).

![Останавливаем сервис](image/1.10.jpg){#fig-110 width=70%}

Пояснение:

Это железно доказало, что наша предыдущая проблема была только в файрволе. Несмотря на то, что мы добавляли сервис nfs в firewalld, этого оказалось недостаточно. NFS использует много вспомогательных RPC-портов, и файрвол, видимо, не все нужные дырки проковырял. Как только мы его отключили, связь прошла, и сервер сразу же показал, что он готов делиться папкой /srv/nfs.

11. На сервере запустите сервис межсетевого экрана ([рис. @fig-111]).

![Запускаем сервис](image/1.11.jpg){#fig-111 width=70%}

12. На сервере посмотрите, какие службы задействованы при удалённом монтирова-
нии:
lsof | grep TCP
lsof | grep UDP ([рис. @fig-112]).

![Смотрим какие службы задействованы](image/1.12.jpg){#fig-112 width=70%}

13. Добавьте службы rpc-bind и mountd в настройки межсетевого экрана на сервере:
firewall-cmd --get-services
firewall-cmd --add-service=mountd --add-service=rpc-bind
firewall-cmd --add-service=mountd --add-service=rpc-bind --permanent
firewall-cmd --reload ([рис. @fig-113]).

![Добавьте службы](image/1.13.jpg){#fig-113 width=70%}

14. На клиенте проверьте подключение удалённого ресурса (вместо user укажите свой
логин):
showmount -e server.user.net ([рис. @fig-114]).

![Проверьте подключение удаленного ресурса](image/1.14.jpg){#fig-114 width=70%}

## Монтирование NFS на клиенте

1. На клиенте создайте каталог, в который будет монтироваться удалённый ресурс,
и подмонтируйте дерево NFS (вместо user укажите свой логин):
mkdir -p /mnt/nfs 
mount server.user.net:/srv/nfs /mnt/nfs ([рис. @fig-021]).

![Создаем каталог](image/2.1.jpg){#fig-021 width=70%}

2. Проверьте, что общий ресурс NFS подключён правильно:
mount (см. рис. @fig-022).

![Общий ресурс подключен правильно](image/2.2.jpg){#fig-022 width=70%}

Пояснение:

Снимок экрана подтверждает успешное подключение удаленного ресурса NFS. В нижней части вывода видно, что ресурс server.mvchigladze.net:/srv/nfs примонтирован к локальному каталогу /mnt/nfs как файловая система типа nfs4.

3. На клиенте в конце файла /etc/fstab добавьте следующую запись (вместо user
укажите свой логин):
server.user.net:/srv/nfs /mnt/nfs nfs _netdev 0 0 (см. рис. @fig-023).

![Добавляем запись в конце файла](image/2.3.jpg){#fig-023 width=70%}

Пояснение:

В конец файла /etc/fstab добавлена строка, которая обеспечивает автоматическое монтирование удаленного ресурса NFS при загрузке системы:

server.mvchigladze.net:/srv/nfs /mnt/nfs nfs _netdev 0 0

Опция _netdev указывает системе, что этот ресурс зависит от сети и должен монтироваться только после инициализации сетевых интерфейсов.

4. На клиенте проверьте наличие автоматического монтирования удалённых ресур-
сов при запуске операционной системы:
systemctl status remote-fs.target (см. рис. @fig-024).

![Проверим наличие монтирования](image/2.4.jpg){#fig-024 width=70%}

5. Перезапустите клиента и убедитесь, что удалённый ресурс подключается автома-
тически

## Подключение каталогов к дереву NFS

1. На сервере создайте общий каталог, в который затем будет подмонтирован каталог
с контентом веб-сервера:
mkdir -p /srv/nfs/www ([рис. @fig-031]).

![Создадим общий каталог](image/3.1.jpg){#fig-031 width=70%}

2. Подмонтируйте каталог web-сервера:
mount -o bind /var/www/ /srv/nfs/www/ ([рис. @fig-032]).

![Подмонтируем каталог вебсервера](image/3.2.jpg){#fig-032 width=70%}

3. На сервере проверьте, что отображается в каталоге /srv/nfs. ([рис. @fig-033]).

![На сервере проверим что отображается](image/3.3.jpg){#fig-033 width=70%}

4. На клиенте посмотрите, что отображается в каталоге /mnt/nfs. ([рис. @fig-034]).

![На клиенте посмотрела что отображается](image/3.4.jpg){#fig-034 width=70%}

5. На сервере в файле /etc/exports добавьте экспорт каталога веб-сервера с удалён-
ного ресурса:
/srv/nfs/www 192.168.0.0/16(rw) ([рис. @fig-035]).

![Добавила экспорт](image/3.5.jpg){#fig-035 width=70%}

6. Экспортируйте все каталоги, упомянутые в файле /etc/exports:
exportfs -r ([рис. @fig-036]).

![Экспортировала все каталоги](image/3.6.jpg){#fig-036 width=70%}

7. Проверьте на клиенте каталог /mnt/nfs. ([рис. @fig-037]).

![Проверила на клиенте каталог](image/3.7.jpg){#fig-037 width=70%} 

8. На сервере в конце файла /etc/fstab добавьте следующую запись:
/var/www /srv/nfs/www none bind 0 0 ([рис. @fig-038]).

![Добавила следующую запись](image/3.8.jpg){#fig-038 width=70%}

9. Повторно экспортируйте каталоги, указанные в файле /etc/exports:
exportfs -r ([рис. @fig-039]).

![Экспортировала каталоги](image/3.9.jpg){#fig-039 width=70%}

10. На клиенте проверьте каталог /mnt/nfs. ([рис. @fig-310]).

![Проверила каталог](image/3.10.jpg){#fig-310 width=70%}

## Подключение каталогов для работы пользователей

1. На сервере под пользователем user в его домашнем каталоге создайте каталог
common с полными правами доступа только для этого пользователя, а в нём файл
user@server.txt (вместо user укажите свой логин):
mkdir -p -m 700 ~/common
cd ~/common
touch user@server.txt ([рис. @fig-041]).

![Создала каталог и файлы](image/4.1.jpg){#fig-041 width=70%}

2. На сервере создайте общий каталог для работы пользователя user по сети (вместо
user укажите свой логин):
mkdir -p /srv/nfs/home/user ([рис. @fig-042]).

![Создала общий каталог](image/4.2.jpg){#fig-042 width=70%}

3. Подмонтируйте каталог common пользователя user в NFS (вместо user укажите свой
логин):
mount -o bind /home/user/common /srv/nfs/home/user ([рис. @fig-0431] [рис. @fig-0432]).

![Подмонтировала каталог](image/4.3.1.jpg){#fig-0431 width=70%}

![Проверила каталог](image/4.3.2.jpg){#fig-0432 width=70%}

Права доступа на каталог ~/common были установлены с помощью опции -m 700 в команде mkdir.

Установленные права доступа:

•  Октальное значение: 700
•  Символьное представление: rwx------

Пояснение:

Эти права означают, что:

•  Владелец (user): Имеет полные права (7), то есть чтение (r), запись (w) и выполнение/доступ (x).
•  Группа (Group): Не имеет никаких прав (0).
•  Остальные пользователи (Others): Не имеют никаких прав (0).

Таким образом, доступ к содержимому каталога common имеет только его владелец.

4. Подключите каталог пользователя в файле /etc/exports, прописав в нём (вместо
user укажите свой логин):
/srv/nfs/home/user 192.168.0.0/16(rw) ([рис. @fig-044]).

![Подключила каталог](image/4.4.jpg){#fig-044 width=70%}

5. Внесите изменения в файл /etc/fstab (вместо user укажите свой логин):
/home/user/common /srv/nfs/home/user none bind 0 0 ([рис. @fig-045]).

![Внесла изменения в файл](image/4.5.jpg){#fig-045 width=70%}

6. Повторно экспортируйте каталоги:
exportfs -r ([рис. @fig-046]).

![Экспортировала каталог](image/4.6.jpg){#fig-046 width=70%}

7. На клиенте проверьте каталог /mnt/nfs. ([рис. @fig-047]).

![Проверила каталог](image/4.7.jpg){#fig-047 width=70%}

8. На клиенте под пользователем user перейдите в каталог /mnt/nfs/home/user
и попробуйте создать в нём файл user@client.txt и внести в него какие-либо изме-
нения:
cd /mnt/nfs/home/user
touch user@client.txt
Попробуйте проделать это под пользователем root. ([рис. @fig-048]).

![Перешла в каталог](image/4.8.jpg){#fig-048 width=70%}

9. На сервере посмотрите, появились ли изменения в каталоге пользователя
/home/user/common. ([рис. @fig-049]).

![Появились ли изменения в каталоге](image/4.9.jpg){#fig-049 width=70%}

## Внесение изменений в настройки внутреннего окружения виртуальных машин

1. На виртуальной машине server перейдите в каталог для внесения изменений
в настройки внутреннего окружения /vagrant/provision/server/, создайте в нём
каталог nfs, в который поместите в соответствующие подкаталоги конфигурацион-
ные файлы:
cd /vagrant/provision/server
mkdir -p /vagrant/provision/server/nfs/etc
cp -R /etc/exports /vagrant/provision/server/nfs/etc/ ([рис. @fig-051]).

![Перешла в каталог](image/5.1.jpg){#fig-051 width=70%}

2. В каталоге /vagrant/provision/server создайте исполняемый файл nfs.sh:
cd /vagrant/provision/server
touch nfs.sh
chmod +x nfs.sh ([рис. @fig-052]).

![Создала исполняемый файл](image/5.2.jpg){#fig-052 width=70%}

3. На виртуальной машине client перейдите в каталог для внесения изменений в на-
стройки внутреннего окружения /vagrant/provision/client/:
cd /vagrant/provision/client ([рис. @fig-053]).

![Перешла в каталог](image/5.3.jpg){#fig-053 width=70%}

4. В каталоге /vagrant/provision/client создайте исполняемый файл nfs.sh:
cd /vagrant/provision/client
touch nfs.sh
chmod +x nfs.sh ([рис. @fig-054]).

![Создала исполняемый файл](image/5.4.jpg){#fig-054 width=70%}

5. Для отработки созданных скриптов во время загрузки виртуальных машин server
и client в конфигурационном файле Vagrantfile необходимо добавить в соответ-
ствующих разделах конфигураций для сервера и клиента ([рис. @fig-055]).

![Добавляем необходимое в конфигурационный файл](image/5.5.jpg){#fig-055 width=70%}

# Выводы

При выполнении лабораторных работ, я приобрела навыки настройки сервера NFS для удалённого доступа к ресурсам.

# Список литературы{.unnumbered}

::: {#refs}
:::
