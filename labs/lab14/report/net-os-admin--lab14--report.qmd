---
## Author
author:
  name: Чигладзе Майя Владиславовна
  degrees: student
  orcid: 0000-0002-0877-7063
  email: 1132239399@pfur.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 119530
      city: Москва
      address: ул. Очаковское шоссе, д. 9А

## Title
title: "Отчёт по лабораторной работе №14"
subtitle: "Администрирование сетевых подсистем"
license: "CC BY"
---

# Цель работы

Приобретение навыков настройки доступа групп пользователей к общим ресурсам по протоколу SMB.

# Задание

1. Установите и настройте сервер Samba 
2. Настройте на клиенте доступ к разделяемым ресурсам 
3. Напишите скрипты для Vagrant, фиксирующие действия по установке и настройке
сервера Samba для доступа к разделяемым ресурсам во внутреннем окружении
виртуальных машин server и client. Соответствующим образом необходимо внести
изменения в Vagrantfile 

# Теоретическое введение

Протокол Server Message Block (SMB) предназначен для организации межпроцессор-
ного взаимодействия, а также удалённого доступа к разделяемым сетевым ресурсам
(файлам, принтерам и проч.).
По сути, SMB выполняет аналогичные NFS-функции, но лучше него работает при
необходимости организации взаимодействия между Unix/Linux узлами и узлами сети
с операционной системой Windows. Различия заключаются, например, в наличии/от-
сутствии:
– информации о владельцах разделяемого ресурса;
– поддержки блокирования ресурса по режиму работы;
– информации о правах доступа, UID и GID ресурса.
Пакет программ Samba представляет собой свободную реализацию приложения на
базе протокола SMB и позволяет Unix/Linux узлам взаимодействовать с сетью, постро-
енной на основе MS Windows. Samba имеет клиент-серверную архитектуру, работает
поверх TCP/IP. В качестве файловой системы может использоваться smbfs или cifs
(Common Internet File System).
Основной файл конфигурации Samba — /etc/samba/smb.conf. В нём задаются огра-
ничения на доступ к системным ресурсам извне. Файл содержит разделы с описанием.
Каждый раздел начинается с его заголовка в квадратных скобках, например, [global],
[homes], [printers] и т.п. Разделы содержат параметры в формате имя = значение.
Имена разделов и параметров не чувствительны к регистру. Начальные, концевые
и внутренние пробелы некорректны в названиях секций и именах параметров. На-
чальные и концевые пробелы в значении параметров игнорируются. Внутренний
пробел в значении параметра сохраняется дословно. Все строки, начинающиеся с за-
пятой, с символа «;» или «#», игнорируются как строки, содержащие только пробел. Все
строки, оканчивающиеся символом «\», продолжаются на следующей строке в стиле
UNIX. Значения после символа равенства в параметрах содержат строку (без кавычек)
или логическое значение: yes/no, 0/1 или true/false.

# Выполнение лабораторной работы

## Настройка сервера Samba

1. На сервере установите необходимые пакеты:
dnf -y install samba samba-client cifs-utils (см. рис. @fig-011).

![Установим каталоги](image/1.1.jpg){#fig-011 width=70%}

2. Создайте группу sambagroup для пользователей, которые будут работать с Samba-
сервером, и присвойте ей GID 1010:
groupadd -g 1010 sambagroup (см. рис. @fig-012).

![Создадим группу](image/1.2.jpg){#fig-012 width=70%}

3. Добавьте пользователя user к группе sambagroup (вместо user используйте ваш ло-
гин):
usermod -aG sambagroup user (см. рис. @fig-013).

![Добавим пользователя](image/1.3.jpg){#fig-013 width=70%}

4. Создайте общий каталог в файловой системе Linux, в который предполагается
монтировать разделяемые ресурсы:
mkdir -p /srv/sambashare (см. рис. @fig-014).

![Создадим общий каталог](image/1.4.jpg){#fig-014 width=70%}

5. В файле конфигурации /etc/samba/smb.conf:
(a) измените параметр рабочей группы (вместо USER укажите имя (логин) вашего
пользователя):
[global]
workgroup = USER-NET
(b) в конце файла добавьте раздел с описанием общего доступа к разделяемому
ресурсу /srv/sambashare:
[sambashare]
comment = My Samba Share
path = /srv/sambashare
write list = @sambagroup ([рис. @fig-015]).

![В файле конфигурации изменим параметр группы](image/1.5.jpg){#fig-015 width=70%}

6. Убедитесь, что вы не сделали синтаксических ошибок в файле smb.conf, используя
команду:
testparm ([рис. @fig-016]).

![Убедитесь что вы не сделали ошибок](image/1.6.jpg){#fig-016 width=70%}

7. Запустите демон Samba и посмотрите его статус:
systemctl start smb
systemctl enable smb
systemctl status smb ([рис. @fig-017]).

![Запустите демон Самба](image/1.7.jpg){#fig-017 width=70%}

8. Для проверки наличия общего доступа попробуйте подключиться к серверу с помо-
щью smbclient:
smbclient -L //server ([рис. @fig-018]).

![Проверим наличие общего досутпа](image/1.8.jpg){#fig-018 width=70%}

(при запросе пароля нажмите Enter для работы под анонимным пользователем).
9. Посмотрите файл конфигурации межсетевого экрана для Samba:
less /usr/lib/firewalld/services/samba.xml ([рис. @fig-019]).

![Смотрим файл конфигурации](image/1.9.jpg){#fig-019 width=70%}

10. Настройте межсетевой экран:
firewall-cmd --add-service=samba
firewall-cmd --add-service=samba --permanent
firewall-cmd --reload ([рис. @fig-110]).

![Настраиваем межсетевой экран](image/1.10.jpg){#fig-110 width=70%}

11. Настройте права доступа для каталога с разделяемым ресурсом:
chgrp sambagroup /srv/sambashare
chmod g=rwx /srv/sambashare ([рис. @fig-111]).

![Настраиваем права](image/1.11.jpg){#fig-111 width=70%}

12. Посмотрите контекст безопасности SELinux:
cd /srv
ls -Z ([рис. @fig-112]).

![Смотрим контекст безопасности](image/1.12.jpg){#fig-112 width=70%}

13. Настройте контекст безопасности SELinux для каталога с разделяемым ресурсом:
semanage fcontext -a -t samba_share_t "/srv/sambashare(/.*)?"
restorecon -vR /srv/sambashare ([рис. @fig-113]).

![Настраиваем контекст](image/1.13.jpg){#fig-113 width=70%}

14. Проверьте, что контекст безопасности изменился:
cd /srv
ls -Z ([рис. @fig-114]).

![Проверяем](image/1.14.jpg){#fig-114 width=70%}

15. Разрешите экспортировать разделяемые ресурсы для чтения и записи:
setsebool samba_export_all_rw 1
setsebool samba_export_all_rw 1 -P ([рис. @fig-115]).

![Рарешаем экспорт](image/1.15.jpg){#fig-115 width=70%}

16. Посмотрите UID вашего пользователя и в какие группы он включён:
id ([рис. @fig-116]).

![Смотрим ЮАЙДИ пользователя](image/1.16.jpg){#fig-116 width=70%}

17. Под вашим пользователем user попробуйте создать файл на разделяемом ресурсе
(вместо user используйте ваш логин):
cd /srv/sambashare
touch user@server.txt ([рис. @fig-117]).

![Пробуем создать файл](image/1.17.jpg){#fig-117 width=70%}

18. Добавьте вашего пользователя user в базу пользователей Samba (вместо user ис-
пользуйте ваш логин):
smbpasswd -L -a user
(при запросе укажите пароль для SMB-пользователя, например, совпадающий с па-
ролем учётной записи вашего пользователя user). ([рис. @fig-118]).

![Добавим пользователя](image/1.18.jpg){#fig-118 width=70%}

## Монтирование файловой системы Samba на клиенте

1. На клиенте установите необходимые пакеты1:
dnf -y install samba-client cifs-utils ([рис. @fig-021]).

![Установим пакеты](image/2.1.jpg){#fig-021 width=70%}

2. На клиенте посмотрите файл конфигурации межсетевого экрана для клиента
Samba:
less /usr/lib/firewalld/services/samba-client.xml (см. рис. @fig-022).

![Просматриваем файл](image/2.2.jpg){#fig-022 width=70%}

3. На клиенте настройте межсетевой экран:
firewall-cmd --add-service=samba-client
firewall-cmd --add-service=samba-client --permanent
firewall-cmd --reload (см. рис. @fig-023).

![Настраиваем экран](image/2.3.jpg){#fig-023 width=70%}

4. На клиенте создайте группу sambagroup и добавьте в неё пользователя user (вместо
user используйте ваш логин):
groupadd -g 1010 sambagroup
usermod -aG sambagroup user (см. рис. @fig-024).

![Создаем группу](image/2.4.jpg){#fig-024 width=70%}

5. На клиенте в файле конфигурации /etc/samba/smb.conf измените параметр рабо-
чей группы:
[global]
workgroup = USER-NET ([рис. @fig-025]).

![Меняем параметры](image/2.5.jpg){#fig-025 width=70%}

6. Для проверки наличия общего доступа попробуйте подключиться с клиента к сер-
веру с помощью smbclient:
smbclient -L //server ([рис. @fig-026]).

![Пробуем подключаться](image/2.6.jpg){#fig-026 width=70%}

Ресурсы сервера просматриваются под анонимной учетной записью (Anonymous login successful).

Хотя система сначала запрашивает пароль для пользователя root в рабочей группе MVCHIGLADZE-NET, успешный просмотр ресурсов происходит благодаря анонимному входу, который разрешен на сервере Samba для просмотра списка общих ресурсов (при использовании опции -L).

7. Подключитесь с клиента к серверу с помощью smbclient под учётной записью ва-
шего пользователя (вместо user используйте ваш логин):
smbclient -L //server -U user
Ресурсы сервера просматриваются под учетной записью пользователя mvchigladze. ([рис. @fig-027]).

![](image/2.7.jpg){#fig-027 width=70%}

8. На клиенте создайте точку монтирования:
mkdir /mnt/samba ([рис. @fig-028]).

![Создаем точку монтирования](image/2.8.jpg){#fig-028 width=70%}

9. На клиенте получите доступ к общему ресурсу с помощью mount (вместо user_name
используйте ваш логин):
mount -o username=user_name,user,rw,uid=user_name,gid=sambagroup
//server/sambashare /mnt/samba↪
При появлении запроса пароля введите пароль SMB-пользователя. ([рис. @fig-029]).

![Получаем доступ к ресурсу](image/2.9.jpg){#fig-029 width=70%}

10. Убедитесь, что user может записывать файлы на разделяемом ресурсе (вместо user
используйте ваш логин):
cd /mnt/samba
touch user@client.txt ([рис. @fig-210]).

![Может записывать файл](image/2.10.jpg){#fig-210 width=70%}

11. Отмонтируйте каталог /mnt/samba:
umount /mnt/samba ([рис. @fig-211]).

![Отмонтируй каталог](image/2.11.jpg){#fig-211 width=70%}

12. Для настройки работы с Samba с помощью файла учётных данных:
(a) на клиенте создайте файл smbusers в каталоге /etc/samba/:
touch /etc/samba/smbusers
chmod 600 /etc/samba/smbusers ([рис. @fig-212]).

![Создаем файл](image/2.12.jpg){#fig-212 width=70%}

13. Убедившись, что ресурс монтируется, вы можете перезагрузить клиента для про-
верки, что ресурс монтируется и после перезагрузки, а у пользователя есть доступ
к разделяемым ресурсам. 

## Внесение изменений в настройки внутреннего окружения виртуальных машин

1. На виртуальной машине server перейдите в каталог для внесения изменений
в настройки внутреннего окружения /vagrant/provision/server/, создайте в нём
каталог smb, в который поместите в соответствующие подкаталоги конфигурацион-
ные файлы:
cd /vagrant/provision/server
mkdir -p /vagrant/provision/server/smb/etc/samba
cp -R /etc/samba/smb.conf /vagrant/provision/server/smb/etc/samba/ ([рис. @fig-031]).

![Переходим в каталог](image/3.1.jpg){#fig-031 width=70%}

2. В каталоге /vagrant/provision/server создайте исполняемый файл smb.sh:
cd /vagrant/provision/server ([рис. @fig-032]).

![Создаем исполняемый файл](image/3.2.jpg){#fig-032 width=70%}

3. На виртуальной машине client перейдите в каталог для внесения изменений
в настройки внутреннего окружения /vagrant/provision/client/, создайте в нём
каталог smb, в который поместите в соответствующие подкаталоги конфигурацион-
ные файлы:
cd /vagrant/provision/client
mkdir -p /vagrant/provision/client/smb/etc/samba
cp -R /etc/samba/smb.conf /vagrant/provision/client/smb/etc/samba/
cp -R /etc/samba/smbusers /vagrant/provision/client/smb/etc/samba/ ([рис. @fig-033]).

![Переходим в каталог](image/3.3.jpg){#fig-033 width=70%}

4. В каталоге /vagrant/provision/client создайте исполняемый файл smb.sh:
cd /vagrant/provision/client
touch smb.sh
chmod +x smb.sh ([рис. @fig-034]).

![Создаем исполняемый файл](image/3.4.jpg){#fig-034 width=70%}

5. Для отработки созданных скриптов во время загрузки виртуальных машин server
и client в конфигурационном файле Vagrantfile необходимо добавить в соответ-
ствующих разделах конфигураций для сервера и клиент ([рис. @fig-035]).

![Создаем скрипт](image/3.5.jpg){#fig-035 width=70%}

# Выводы

В ходе выполнения лабораторной работы, я приобрела навыки настройки доступа групп пользователей к общим ресурсам по протоколу SMB.

# Список литературы{.unnumbered}

1. Всё о Samba. — URL: http://smb-conf.ru/ (дата обр. 13.09.2021).

::: {#refs}
:::
