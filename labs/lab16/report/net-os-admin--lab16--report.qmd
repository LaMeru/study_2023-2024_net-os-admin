---
## Author
author:
  name: Чигладзе Майя Владиславовна
  degrees: student
  orcid: 0000-0002-0877-7063
  email: 1132239399@pfur.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 119530
      city: Москва
      address: ул. Очаковское шоссе, д. 9А

## Title
title: "Отчёт по лабораторной работе 16"
subtitle: "Администрирование сетевых подсистем"
license: "CC BY"
---

# Цель работы

Получить навыки работы с программным средством Fail2ban для обеспечения базовой защиты от атак типа «brute force».

# Задание

1. Установите и настройте Fail2ban для отслеживания работы установленных на сер-
вере служб 
2. Проверьте работу Fail2ban посредством попыток несанкционированного доступа
с клиента на сервер через SSH 
3. Напишите скрипт для Vagrant, фиксирующий действия по установке и настройке
Fail2ban 

# Теоретическое введение

Одно из решений по защите узла сети от несанкционированного доступа и атак типа
«brute force» (в частности, подбора паролей администратора методом полного перебо-
ра) — использование Fail2ban [1]. Данное программное средство отслеживает сетевую
активность на портах узла путём сканирования текстовых лог-файлов. При выявле-
нии программой неадекватной активности какого-то узла его IP-адрес помещается
в чёрный список, а все пакеты с этого адреса блокируются. Блокировка настраивается
путём внесения изменений в правила межсетевого экрана.
Файл /etc/fail2ban/fail2ban.conf содержит настройки запуска процес-
са Fail2ban. Основной файл конфигурации конкретных служб в Fail2ban —
/etc/fail2ban/jail.conf, настройки для локального узла должны быть разме-
щены в файле NAMEFILE.local в каталоге /etc/fail2ban/jail.d, конфигурации для
работы с различными службами размещаются в отдельных подкаталогах и файлах
в каталоге /etc/fail2ban/.
Каждый конфигурационный файл Fail2ban имеет секции, каждая из которых опи-
сывает определённую службу и тип атаки.
Базовые правила fail2ban в конфигурационном файле:
– ignoreip — не блокировать IP-адреса из этого списка; несколько IP-адресов разде-
ляются пробелами;
– bantime — время блокировки в секундах (по умолчанию — 600, т.е. 10 минут); для
постоянного блокирования используется любое отрицательное число;
– findtime — длительность интервала времени в секундах, в течение которого
fail2ban отслеживает подозрительную активность (по умолчанию — 10 минут);
– maxretry — количество подозрительных совпадений, после которых IP-адрес блоки-
руется (по умолчанию — 3 попытки).

# Выполнение лабораторной работы

## Защита с помощью Fail2ban

1. На сервере установите fail2ban:
dnf -y install fail2ban (см. рис. @fig-011).

![Установила фаил2бан](image/1.1.jpg){#fig-011 width=70%}

2. Запустите сервер fail2ban:
systemctl start fail2ban
systemctl enable fail2ban (см. рис. @fig-012).

![Запустила сервер](image/1.2.jpg){#fig-012 width=70%}

3. В дополнительном терминале запустите просмотр журнала событий fail2ban:
tail -f /var/log/fail2ban.log (см. рис. @fig-013).

![В доп терминале запустила просмотр журнала](image/1.3.jpg){#fig-013 width=70%}

4. Создайте файл с локальной конфигурацией fail2ban:
touch /etc/fail2ban/jail.d/customisation.local (см. рис. @fig-014).

![Создала файл](image/1.4.jpg){#fig-014 width=70%}

5. В файле /etc/fail2ban/jail.d/customisation.local:
(a) задайте время блокирования на 1 час (время задаётся в секундах):
[DEFAULT]
bantime = 3600
(b) включите защиту SSH:
#
# SSH servers
#
[sshd]
port = ssh,2022
enabled = true
[sshd-ddos]
filter = sshd
enabled = true
[selinux-ssh]
enabled = true ([рис. @fig-015]).

![В файле зададала время блокирования](image/1.5.jpg){#fig-015 width=70%}

6. Перезапустите fail2ban
systemctl restart fail2ban ([рис. @fig-016]).

![Перезапустила](image/1.6.jpg){#fig-016 width=70%}

7. Посмотрите журнал событий:
tail -f /var/log/fail2ban.log ([рис. @fig-017]).

![Просмотрела журнал событий](image/1.7.jpg){#fig-017 width=70%}

8. В файле /etc/fail2ban/jail.d/customisation.local включите защиту HTTP ([рис. @fig-018]).

![Включила защиту](image/1.8.jpg){#fig-018 width=70%}

9. Перезапустите fail2ban
systemctl restart fail2ban ([рис. @fig-019]).

![Перезапустила файилтубан](image/1.9.jpg){#fig-019 width=70%}

10. Посмотрите журнал событий:
tail -f /var/log/fail2ban.log ([рис. @fig-110]).

![Посмотрела журнал событий](image/1.10.jpg){#fig-110 width=70%}

11. В файле /etc/fail2ban/jail.d/customisation.local включите защиту почты:
#
# Mail servers
#
[postfix]
enabled = true
[postfix-rbl]
enabled = true
[dovecot]
enabled = true
[postfix-sasl]
enabled = true ([рис. @fig-111]).

![Включила защиту](image/1.11.jpg){#fig-111 width=70%}

12. Перезапустите fail2ban:
systemctl restart fail2ban ([рис. @fig-112]).

![Перезапустила фаилтубан](image/1.12.jpg){#fig-112 width=70%}

13. Посмотрите журнал событий:
tail -f /var/log/fail2ban.log ([рис. @fig-113]).

![Посмотрела журнал событий](image/1.13.jpg){#fig-113 width=70%}

## Проверка работы Fail2ban

1. На сервере посмотрите статус fail2ban:
fail2ban-client status ([рис. @fig-021]).

![На сервере посмотрела статус](image/2.1.jpg){#fig-021 width=70%}

2. Посмотрите статус защиты SSH в fail2ban:
fail2ban-client status sshd 

3. Установите максимальное количество ошибок для SSH, равное 2:
fail2ban-client set sshd maxretry 2 

4. С клиента попытайтесь зайти по SSH на сервер с неправильным паролем. (см. рис. @fig-024).

![Попыталась зайти по ссш](image/2.4.jpg){#fig-024 width=70%}

5. На сервере посмотрите статус защиты SSH:
fail2ban-client status sshd
Убедитесь, что произошла блокировка адреса клиента. ([рис. @fig-025]).

![Посмотрела статус защиты](image/2.5.jpg){#fig-025 width=70%}

6. Разблокируйте IP-адрес клиента:
fail2ban-client set sshd unbanip <ip-адрес клиента> ([рис. @fig-026]).

![Разблокировала айпи адрес](image/2.6.jpg){#fig-026 width=70%}

7. Вновь посмотрите статус защиты SSH:
fail2ban-client status sshd
Убедитесь, что блокировка клиента снята. ([рис. @fig-027]).

![Посмотрела статус защиты](image/2.7.jpg){#fig-027 width=70%}

8. На сервере внесите изменение в конфигурационный файл
/etc/fail2ban/jail.d/customisation.local, добавив в раздел по умолчанию
игнорирование адреса клиента:
[DEFAULT]
bantime = 3600
ignoreip = 127.0.0.1/8 <ip-адрес клиента>
(вместо <ip-адрес клиента> укажите конкретный адрес). 

9. Перезапустите fail2ban.  

10. Посмотрите журнал событий:
tail -f /var/log/fail2ban.log 

11. Вновь попытайтесь войти с клиента на сервер с неправильным паролем и посмот-
рите статус защиты SSH. ([рис. @fig-211]).

![Попыталась войти с клиента](image/2.11.jpg){#fig-211 width=70%}

## Внесение изменений в настройки внутреннего
окружения виртуальных машин

1. На виртуальной машине server перейдите в каталог для внесения изменений
в настройки внутреннего окружения /vagrant/provision/server/, создайте в нём
каталог protect, в который поместите в соответствующие подкаталоги конфигура-
ционные файлы:
cd /vagrant/provision/server
mkdir -p /vagrant/provision/server/protect/etc/fail2ban/jail.d
cp -R /etc/fail2ban/jail.d/customisation.local
/vagrant/provision/server/protect/etc/fail2ban/jail.d/ ([рис. @fig-031]).

![На вм перешла в каталог](image/3.1.jpg){#fig-031 width=70%}

2. В каталоге /vagrant/provision/server создайте исполняемый файл protect.sh:
cd /vagrant/provision/server
touch protect.sh
chmod +x protect.sh
Открыв его на редактирование, пропишите в нём следующий скрипт:
#!/bin/bash
echo "Provisioning script $0"
echo "Install needed packages"
dnf -y install fail2ban
echo "Copy configuration files"
cp -R /vagrant/provision/server/protect/etc/* /etc
restorecon -vR /etc ([рис. @fig-032]).

![Создала исполняемый файл](image/3.2.jpg){#fig-032 width=70%}

3. echo "Start fail2ban service"
systemctl enable fail2ban
systemctl start fail2ban
Для отработки созданного скрипта во время загрузки виртуальной машины server
в конфигурационном файле Vagrantfile необходимо добавить в соответствующем
разделе конфигураций для сервера  

# Выводы

В ходе лабораторной работы, я получила навыки работы с программным средством Fail2ban для обеспечения базовой защиты от атак типа «brute force».

# Список литературы{.unnumbered}

1. Сайт Fail2ban. — URL: https://www.fail2ban.org (visited on 09/13/2021).

::: {#refs}
:::
